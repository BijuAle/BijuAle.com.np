<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cloudinary HEIC Upload</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
  <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 2rem;
      background-color: #f9f9f9;
      color: #333;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    input, select, textarea, button {
      margin-top: 0.8rem;
      padding: 0.6rem;
      width: 100%;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .meta {
      margin-top: 2rem;
    }
    .photo-meta {
      background: #f0f0f0;
      padding: 1rem;
      margin-top: 1rem;
      border-left: 4px solid #4CAF50;
    }
    .photo-meta label {
      font-weight: bold;
      display: block;
      margin-top: 0.5rem;
    }
    .photo-meta input, .photo-meta textarea {
      margin-top: 0.2rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Cloudinary Image Uploader</h1>
    <label>Cloud Name:</label>
    <input type="text" id="cloudName" placeholder="Enter Cloudinary cloud name" required />

    <label>Upload Preset:</label>
    <input type="text" id="uploadPreset" placeholder="Enter upload preset" required />

    <label>Select Images (HEIC/JPG):</label>
    <input type="file" id="fileInput" multiple accept="image/*" />

    <div id="preview" class="meta"></div>
    <label>Note (applies to all):</label>
    <textarea id="note" placeholder="Enter any note..."></textarea>

    <button onclick="uploadFiles()">Upload to Cloudinary</button>

    <div id="results" class="meta"></div>
  </div>

  <script>
    const fileMetadataMap = new Map();

    function convertDMSToDD(dms, ref) {
      const [deg, min, sec] = dms;
      let dd = deg + min / 60 + sec / 3600;
      if (ref === 'S' || ref === 'W') dd *= -1;
      return dd.toFixed(6);
    }

    async function readExif(file) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = function (e) {
          const arrayBuffer = e.target.result;
          EXIF.getData({ src: arrayBuffer }, function () {
            const exifData = EXIF.getAllTags(this);
            resolve(exifData);
          });
        };
        reader.readAsArrayBuffer(file);
      });
    }

    document.getElementById('fileInput').addEventListener('change', async function () {
      const previewDiv = document.getElementById('preview');
      previewDiv.innerHTML = '';
      fileMetadataMap.clear();

      for (const file of this.files) {
        const exif = await readExif(file);

        const camera = exif.Model || '';
        const date = exif.DateTimeOriginal ? new Date(exif.DateTimeOriginal.replace(/:/g, '-').replace(' ', 'T') + ':00Z').toISOString() : '';
        const focalLength = exif.FocalLength || '';
        const gps = (exif.GPSLatitude && exif.GPSLongitude)
          ? `${convertDMSToDD(exif.GPSLatitude, exif.GPSLatitudeRef)},${convertDMSToDD(exif.GPSLongitude, exif.GPSLongitudeRef)}`
          : '';
        const iso = exif.ISOSpeedRatings || '';
        const shutter = exif.ExposureTime || '';

        const block = document.createElement('div');
        block.classList.add('photo-meta');
        block.innerHTML = `
          <label>Title (Caption)</label>
          <input type="text" class="title" placeholder="Enter title/caption">
          <label>Description (Alt)</label>
          <textarea class="description" placeholder="Enter description/alt text"></textarea>
          <label>Camera</label>
          <input type="text" class="camera" value="${camera}">
          <label>Date</label>
          <input type="text" class="date" value="${date}">
          <label>Focal Length</label>
          <input type="text" class="focalLength" value="${focalLength}">
          <label>GPS</label>
          <input type="text" class="gps" value="${gps}">
          <label>ISO</label>
          <input type="text" class="iso" value="${iso}">
          <label>Shutter</label>
          <input type="text" class="shutter" value="${shutter}">
        `;

        previewDiv.appendChild(block);
        fileMetadataMap.set(file.name, { file });
      }
    });

    async function uploadFiles() {
      const files = document.getElementById('fileInput').files;
      const cloudName = document.getElementById('cloudName').value;
      const uploadPreset = document.getElementById('uploadPreset').value;
      const note = document.getElementById('note').value;
      const resultsDiv = document.getElementById('results');
      const previewBlocks = document.querySelectorAll('.photo-meta');

      resultsDiv.innerHTML = '';

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const block = previewBlocks[i];

        const title = block.querySelector('.title').value;
        const description = block.querySelector('.description').value;
        const camera = block.querySelector('.camera').value;
        const date = block.querySelector('.date').value;
        const focalLength = block.querySelector('.focalLength').value;
        const gps = block.querySelector('.gps').value;
        const iso = block.querySelector('.iso').value;
        const shutter = block.querySelector('.shutter').value;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);
        formData.append('context', `caption=${title}|alt=${description}|camera=${camera}|date=${date}|focalLength=${focalLength}|gps=${gps}|iso=${iso}|shutter=${shutter}|note=${note}`);

        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
          method: 'POST',
          body: formData
        });

        const result = await response.json();
        const displayMeta = {
          title, description, camera, date, focalLength, gps, iso, shutter, note
        };
        resultsDiv.innerHTML += `<div class="photo-meta"><strong>Uploaded:</strong> <a href="${result.secure_url}" target="_blank">${result.original_filename}</a><pre>${JSON.stringify(displayMeta, null, 2)}</pre></div>`;
      }
    }
  </script>
</body>
</html>